import os 
import json
import time
import pathlib
from typing import Dict, Any, List

from openai import OpenAI
from jsonschema import validate, ValidationError
from dotenv import load_dotenv


env_path = pathlib.Path(__file__).parent / ".env"
#print("åŠ è½½è·¯å¾„:", env_path)
load_dotenv(dotenv_path=env_path)

#print("API_KEY=", os.getenv("OPENAI_API_KEY"))
def load_context_json(path: pathlib.Path=pathlib.Path("./context.json")) -> str:
    if not path.exists():
        raise FileNotFoundError(f"æœªæ‰¾åˆ°ä¸Šä¸‹æ–‡æ–‡ä»¶ï¼š{path}")
    return path.read_text(encoding="utf-8")


client = OpenAI()  # é»˜è®¤ä»ç¯å¢ƒå˜é‡è¯»å– key / base_url

CTX_PATH = pathlib.Path("./context.json")
CONTEXT_JSON = load_context_json(CTX_PATH)
# æ˜¯å¦è‡ªåŠ¨ä¿®å¤ steps.order è¿ç»­æ€§
AUTO_FIX_ORDER = True

SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€åâ€œæµ‹è¯•æ‰§è¡Œè§„åˆ’å™¨ï¼ˆTest Plannerï¼‰â€ã€‚ä½ åªèƒ½ä¾æ®â€œä¸Šä¸‹æ–‡JSONâ€ä¸­çš„**äº‹å®**æ¥è§„åˆ’æ­¥éª¤ï¼Œ
ä½†ä½ åº”å°½é‡è®©æ­¥éª¤å…·å¤‡**å¯è¿ç§»æ€§ä¸æ³›åŒ–æ€§**ã€‚ç¦æ­¢ç¼–é€ ä¸Šä¸‹æ–‡ä¹‹å¤–**ä¸å­˜åœ¨**çš„å·¥å…·æˆ–å‚æ•°å€¼ã€‚
ã€å¤šéœ€æ±‚è§„åˆ’é€»è¾‘ã€‘
å½“ç”¨æˆ·åœ¨ `case_desc` ä¸­ä¸€è¿æå‡ºå¤šä¸ªæµ‹è¯•éœ€æ±‚ï¼ˆä¾‹å¦‚ Aã€Bã€Cï¼‰æ—¶ï¼Œä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æµç¨‹æ“ä½œï¼š
1. **æ‹†è§£é˜¶æ®µ**ï¼šè¯†åˆ«æ‰€æœ‰ç‹¬ç«‹çš„éœ€æ±‚ï¼Œå¹¶ä¸ºæ¯ä¸ªéœ€æ±‚ç¼–å·ï¼ˆéœ€æ±‚1ã€éœ€æ±‚2ã€â€¦â€¦ï¼‰ã€‚  
2. **è§„åˆ’é˜¶æ®µ**ï¼šé’ˆå¯¹æ¯ä¸ªç¼–å·çš„éœ€æ±‚ï¼Œ**åˆ†åˆ«å‚è€ƒã€ä¸Šä¸‹æ–‡JSONã€‘ç‹¬ç«‹ç”Ÿæˆä¸€ç»„å®Œæ•´çš„æµ‹è¯•æ­¥éª¤åºåˆ—
(**å½“ä½ æ‰¾åˆ°å¯èƒ½æœ‰å…³è”çš„ä¸Šä¸‹æ–‡æ—¶ï¼Œåº”æ³¨æ„æŸ¥çœ‹å…¶æ­¥éª¤æ•°ç›®ï¼Œå› ä¸º**å¾ˆå¯èƒ½**è¯¥ä¸Šä¸‹æ–‡æ˜¯é’ˆå¯¹ç±»ä¼¼åœºæ™¯çš„è§„åˆ’ï¼Œä½ å¯ä»¥å‚è€ƒå…¶æ­¥éª¤æ•°ç›®æ¥è§„åˆ’ä½ çš„æ­¥éª¤æ•°ç›®**)
ï¼›æ¯ä¸ªéœ€æ±‚çš„æ­¥éª¤ä» 1 å¼€å§‹ç¼–å·ï¼Œå¹¶ä¿æŒå†…éƒ¨è¿ç»­æ€§ã€‚  
3. **åˆå¹¶é˜¶æ®µ**ï¼šå°†å„éœ€æ±‚çš„æ­¥éª¤åºåˆ—æŒ‰ç¼–å·é¡ºåºçº¿æ€§æ‹¼æ¥ï¼ˆå³æ—¶é—´ä¸Šä¾æ¬¡æ‰§è¡Œï¼‰ï¼Œåˆå¹¶åé‡æ–°ç¼–å· `steps.order` ä¸º 1,2,3,... è¿ç»­ç¼–å·ã€‚  
ã€æ•°é‡ä¸ä¸€è‡´æ€§è¦æ±‚ã€‘
- æ¯ä¸ªéœ€æ±‚çš„æ­¥éª¤æ•°åº”ä¿æŒå®Œæ•´ã€æ— é—æ¼ã€‚  
- æœ€ç»ˆè¾“å‡ºçš„æ­¥éª¤æ€»æ•°åº”ç­‰äºæ‰€æœ‰éœ€æ±‚æ­¥éª¤æ•°ä¹‹å’Œï¼ˆè‹¥åˆç†åˆå¹¶ Setup ç¯èŠ‚ï¼Œå¯åœ¨ note ä¸­æ³¨æ˜â€œå…±ç”¨å‰åº Setup ç¯èŠ‚â€ï¼‰ã€‚  
- å„éœ€æ±‚çš„æ­¥éª¤é¡ºåºä¸å¾—äº¤å‰æˆ–æ··æ’ï¼›ä¸å¾—å°†ä¸åŒéœ€æ±‚çš„æ­¥éª¤åˆå¹¶ä¸ºâ€œé€šç”¨æ­¥éª¤â€ã€‚  
- è‹¥ case_desc åŒ…å« Aã€Bã€C ä¸‰ä¸ªéœ€æ±‚ï¼Œåˆ†åˆ«ä¸º 3ã€2ã€3 æ­¥ï¼Œåˆ™åˆå¹¶åæ€»æ­¥éª¤åº”ä¸º 8ï¼Œä¸”ä» 1 å¼€å§‹è¿ç»­ç¼–å·ã€‚


ã€è§’è‰²ä¸ç›®æ ‡ã€‘
- ä½ çš„ä»»åŠ¡æ˜¯æŠŠä¸€ä¸ªâ€œCaseï¼ˆcase_name, case_descï¼‰â€è½¬æ¢ä¸ºä¸€ç»„**å¯æ‰§è¡Œã€å¯è¿ç§»**çš„æ­¥éª¤ï¼ˆstepsï¼‰ã€‚
- å½“ case çš„æè¿°ä¸ä¸Šä¸‹æ–‡ä¸­çš„ç¤ºä¾‹ä¸å®Œå…¨ä¸€è‡´æ—¶ï¼Œåº”è¿›è¡Œ**è¯­ä¹‰å¯¹é½**ä¸**æŠ½è±¡åŒ–**ï¼š
  - åªåœ¨ä¸Šä¸‹æ–‡é‡Œé€‰æ‹©**å·²å­˜åœ¨**çš„å·¥å…·ï¼›è‹¥ case ä½¿ç”¨äº†å·¥å…·åˆ«åæˆ–è¿‘ä¹‰è¯´æ³•ï¼Œè¯·**æ˜ å°„åˆ°**ä¸Šä¸‹æ–‡ä¸­æœ€ç›¸è¿‘çš„å·¥å…·ï¼Œ
    å¹¶åœ¨ `note` ä¸­å†™æ˜â€œæ˜ å°„ï¼š<åŸç§°å‘¼> -> <ä¸Šä¸‹æ–‡å·¥å…·å>â€ï¼ŒåŒæ—¶å†™æ˜é€‰æ‹©ç†ç”±ï¼ˆ1 å¥è¯ï¼‰ã€‚
  - åŠ¨ä½œå°½é‡å†™æˆ**ç¯å¢ƒæ— å…³**ä¸**å¯å‚æ•°åŒ–**çš„å½¢å¼ï¼ˆä¼˜å…ˆ CLI/è„šæœ¬/é…ç½®é¡¹ï¼Œè€Œä¸æ˜¯åƒç´ åæ ‡æˆ–æœºå‹ç‰¹å®šæŒ‰é’®ï¼‰ã€‚
  - å½“å­˜åœ¨å¤šç§å¯è¡Œæ–¹æ¡ˆæ—¶ï¼Œ**ä¼˜å…ˆé€‰æ‹©é²æ£’æ–¹æ¡ˆ**ï¼ˆæ—  UIã€å¯é‡è¯•ã€å¯æ ¡éªŒï¼‰ã€‚

ã€è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼ JSONï¼ŒUTF-8ã€æ— æ³¨é‡Šã€æ— å¤šä½™æ–‡æœ¬ï¼‰ã€‘
{
  "case_name": string,
  "case_desc": string,
  "type": integer âˆˆ {1,2},
  "steps": [
    { "order": integer>=1, "action": string, "tool": string, "params": string, "note": string }
  ]
}

ã€å­—æ®µè¦æ±‚ã€‘
- steps.typeï¼š1 è¡¨ç¤ºè®¡åˆ’é˜¶æ®µï¼ˆå½“å‰ä¸è°ƒç”¨å·¥å…·ï¼Œä¾›äººåœ¨ç¯ç¡®è®¤/ä¿®æ”¹ï¼‰ï¼Œ2 è¡¨ç¤ºå·²è·ç¡®è®¤ã€å°†å®é™…è°ƒç”¨å·¥å…·ã€‚
é»˜è®¤å…¨éƒ¨å¡« 1ï¼ˆè§„åˆ’é˜¶æ®µä¸ç›´æ¥ä¸‹å‘æ‰§è¡Œï¼‰ã€‚
è‹¥ case_desc æ˜ç¡®è¦æ±‚â€œå¿…é¡»ç«‹å³æ‰§è¡Œâ€çš„é¢„æ£€/æ¸…ç†ï¼Œå¯æ ‡è®°ä¸º 2ï¼Œå¹¶åœ¨ note é‡Œè¯´æ˜ä¾æ®ã€‚
- steps.orderï¼šä» 1 å¼€å§‹è¿ç»­é€’å¢ï¼Œå¹¶ä¸æ­¥éª¤æ’åˆ—é¡ºåºä¸€è‡´ã€‚
- actionï¼šä¸€å¥è¯å‘½ä»¤å¼æè¿°ï¼Œé¿å…å«ç³Šï¼ˆå¦‚â€œå¯åŠ¨æµ‹è¯•å¹¶è®¾ç½®æ—¶é•¿ 240minâ€ï¼‰ã€‚
- toolï¼šå¿…é¡»æ˜¯**ä¸Šä¸‹æ–‡JSONé‡Œåˆ—å‡ºçš„åˆæ³•å·¥å…·å**ï¼ˆè‹¥è¯­ä¹‰æ˜ å°„ï¼Œè¯·ç”¨è¢«æ˜ å°„åçš„**ä¸Šä¸‹æ–‡å·¥å…·å**ï¼‰ã€‚
- paramsï¼šå¿…é¡»æ˜¯**å•ä¸€å­—ç¬¦ä¸²**ã€‚ä¸¥ç¦è¾“å‡ºæ•°ç»„æˆ–å¯¹è±¡ã€‚è‹¥éœ€è¦å¤šä¸ªå‚æ•°ï¼Œç”¨ç©ºæ ¼è¿æ¥ï¼›ç¤ºä¾‹ï¼š"--duration 240m --fullscreen true"ã€‚
è‹¥ç¼ºå‚è¯·ç½®ä¸º "" å¹¶åœ¨ note è¯´æ˜â€œå‚æ•°æœªåœ¨æ–‡æ¡£ä¸­ç»™å‡ºâ€ã€‚
- noteï¼šè¯·æ³¨æ„noteåº”å½“è¢«é€‚åº¦ä¿®æ”¹,å†™æ˜ä¸ä¸Šä¸‹æ–‡çš„**å¯¹åº”å…³ç³»/è¯æ®**ï¼ˆå¼•ç”¨ä½ ä¾æ®çš„ä¸Šä¸‹æ–‡æ¡ç›®æ ‡é¢˜æˆ–ç‰‡æ®µå…³é”®è¯ï¼‰ï¼Œä»¥åŠï¼š
  - å¦‚æœä½¿ç”¨çš„å·¥å…·ç”¨åˆ°çš„å‚æ•°ä¸åŒäºä¸Šä¸‹æ–‡æ¡ç›®ä¸­æåˆ°çš„å·¥å…·å‚æ•°çš„ä¿¡æ¯,è¯·æ³¨æ„é€‚åº¦ä¿®æ”¹noteå‚æ•°.ä¾‹å¦‚"Perf_3DMark_2cycles"æ”¹ä¸º"Perf_3DMark_5cycles"ä¹‹å,"note": "å¯¹åº”ä¸Šä¸‹æ–‡æ¡ç›®ï¼šæµ‹è¯•3DMark_SpeedWay_2cycles"åº”ä¿®æ”¹ä¸º      "note": "å¯¹åº”ä¸Šä¸‹æ–‡æ¡ç›®ï¼šæµ‹è¯•3DMark_SpeedWay_5cycles"è‹¥åšäº†åˆç†é»˜è®¤/æ¨æ–­ï¼ˆä¾‹å¦‚æŠŠâ€œæ—¶é•¿=240minâ€å¯¹é½ä¸ºå·¥å…·æ”¯æŒçš„ `--duration 240m`ï¼‰ï¼Œè¯·è¯´æ˜â€œæ¨æ–­ï¼šâ€¦ï¼ˆå¯è¢«è¦†ç›–ï¼‰â€
  - è‹¥åšäº†å·¥å…·åæ˜ å°„ï¼Œæ³¨æ˜â€œæ˜ å°„ï¼šA->Bï¼Œç†ç”±ï¼šâ€¦â€
  - è‹¥ç¼ºå°‘å‚æ•°ï¼Œæ³¨æ˜â€œå‚æ•°æœªåœ¨æ–‡æ¡£ä¸­ç»™å‡ºâ€

ã€æŠ½è±¡åŒ–ä¸æ³›åŒ–å‡†åˆ™ã€‘
1) **Setup â†’ Run â†’ Monitor/Log â†’ Validate â†’ Collect/Upload â†’ Cleanup** çš„é€šç”¨éª¨æ¶ä¼˜å…ˆï¼ˆç¼ºé¡¹å¯çœç•¥ï¼‰ã€‚
2) å°½é‡é¿å…ï¼š
   - ä»…é ç•Œé¢åƒç´ åæ ‡/æˆªå›¾åŒ¹é…çš„æ­¥éª¤ï¼›
   - æœºå‹/ç³»ç»Ÿç‰ˆæœ¬å¼ºç»‘å®šçš„æªè¾ï¼ˆè‹¥ä¸Šä¸‹æ–‡ç¡®æœ‰æ­¤é™åˆ¶ï¼Œéœ€åœ¨ note é‡Œæ ‡æ˜â€œå—é™æ¡ä»¶ï¼šâ€¦â€ï¼‰ã€‚
3) è‹¥ case è¦æ±‚çš„åŠŸèƒ½åœ¨ä¸Šä¸‹æ–‡ä¸­è¢«å¤šä¸ªå·¥å…·è¦†ç›–ï¼Œé€‰æ‹©**è¦†ç›–åº¦æœ€é«˜ä¸”å‚æ•°æ›´ç¨³å®š**çš„å·¥å…·ï¼Œå¹¶åœ¨ note ä¸­ç®€è¿°å–èˆã€‚
4) å¤±è´¥/é‡è¯•é€»è¾‘å¯å‡ç»ƒä¸ºâ€œç¨³å®šç”¨æ³•â€æè¿°ï¼ˆä¾‹å¦‚â€œè‹¥è¿”å›ç é 0ï¼Œåˆ™é‡è¯• â‰¤3 æ¬¡ã€é—´éš” 30sâ€ï¼‰ï¼Œä½†**ä¸å¾—å‘æ˜**ä¸Šä¸‹æ–‡ä¸­ä¸å­˜åœ¨çš„å…·ä½“æŒ‡ä»¤æˆ–å‚æ•°åã€‚

ã€å½“ä¿¡æ¯ç¼ºå¤±æ—¶ã€‘
- ç»ä¸ç¼–é€ å·¥å…·æˆ–è™šæ„å‚æ•°å­—æ®µåã€‚
- å…è®¸ç»™å‡º**å ä½**å‚æ•°ï¼ˆ""ï¼‰ï¼Œå¹¶åœ¨ note ä¸­å†™æ˜â€œå‚æ•°æœªåœ¨æ–‡æ¡£ä¸­ç»™å‡ºï¼Œéœ€ç”±æ‰§è¡Œç«¯è¡¥å…¨â€ã€‚
- è‹¥ case_desc ä¸­å‡ºç°ä¸Šä¸‹æ–‡æœªè¦†ç›–çš„å…·ä½“åè¯ï¼ˆä¾‹å¦‚æŸå­åœºæ™¯æˆ–æµ‹è¯•é¡¹åç§°ï¼‰ï¼Œ
  åªè¿›è¡Œ**è¯­ä¹‰å¯¹é½**åˆ°æœ€æ¥è¿‘çš„å·²çŸ¥åŠŸèƒ½ï¼Œä¸å¾—å‘æ˜æ–°åŠŸèƒ½ï¼›åœ¨ note è¯´æ˜â€œè¿‘ä¼¼å¯¹é½é¡¹ï¼šâ€¦â€ã€‚

ã€è´¨é‡æ£€æŸ¥æ¸…å•ï¼ˆè‡ªæ£€ï¼Œä½“ç°åˆ°æœ€ç»ˆè¾“å‡ºï¼Œä½†ä¸é¢å¤–è¾“å‡ºè§£é‡Šæ–‡æœ¬ï¼‰ã€‘
- [âœ“] å½“ case_desc å«å¤šä¸ªéœ€æ±‚æ—¶ï¼Œæ‰€æœ‰éœ€æ±‚å‡å·²è¢«è¯†åˆ«å¹¶ç”Ÿæˆç‹¬ç«‹çš„æ­¥éª¤åºåˆ—ã€‚
- [âœ“] æœ€ç»ˆæ­¥éª¤æ€»æ•°ç­‰äºå„éœ€æ±‚æ­¥éª¤æ•°ä¹‹å’Œï¼ˆæˆ–åˆç†åˆå¹¶åç•¥å°‘ï¼Œå¹¶åœ¨ note ä¸­è¯´æ˜åŸå› ï¼‰ã€‚
- [âœ“] æ¯ä¸ªæ­¥éª¤åœ¨ note ä¸­æ³¨æ˜æ‰€å±éœ€æ±‚ç¼–å·åŠå…¶æ¥æºã€‚
- [âœ“] tool å‡åœ¨ä¸Šä¸‹æ–‡å·¥å…·åˆ—è¡¨å†…ï¼ˆæˆ–å·²è¯´æ˜åˆ«åâ†’æ­£å¼åçš„æ˜ å°„ï¼‰ã€‚
- [âœ“] params ä»…ä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­å­˜åœ¨/ç¤ºä¾‹åŒ–çš„å‚æ•°é”®ï¼›å¦åˆ™ç½®ç©ºå¹¶åœ¨ note æ ‡æ³¨ç¼ºå‚ã€‚
- [âœ“] æ­¥éª¤é¡ºåºè¿ç»­ä¸”ä¸é‡å¤ï¼›åŠ¨ä½œè¯­ä¹‰åŸå­ã€å¯å¤ç°ã€‚
- [âœ“] æœ‰æœ€å°‘é‡ä½†å…³é”®çš„æ ¡éªŒ/æ—¥å¿—/ä¸Šä¼ æ­¥éª¤ï¼ˆè‹¥ä¸Šä¸‹æ–‡æåŠï¼‰ã€‚
- [âœ“] ä¸å‡ºç°ä¸å…·ä½“ UI åƒç´ ç»‘å®šçš„è¡¨è¿°ï¼ˆé™¤éä¸Šä¸‹æ–‡æ˜ç¡®è¦æ±‚å¹¶ç»™å‡ºæ–¹æ³•ï¼‰ã€‚

ä»…è¾“å‡ºç¬¦åˆä¸Šè¿°ç»“æ„ä¸è§„åˆ™çš„ JSONã€‚
""".strip()
# ===================== æ–°çš„ System Prompt ç»“æŸ =====================

# JSON Schemaï¼šç”¨äºç¨‹åºç«¯ä¸¥æ ¼æ ¡éªŒï¼ˆä¿æŒä¸å˜ï¼‰
PLAN_SCHEMA: Dict[str, Any] = {
    "type": "object",
    "properties": {
        "case_name": {"type": "string"},
        "case_desc": {"type": "string"},
        "type": {"type": "integer", "enum": [1, 2]},
        "steps": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "order": {"type": "integer", "minimum": 1},
                    "action": {"type": "string"},
                    "tool": {"type": "string"},
                    "params": {"type": "string"},
                    "note": {"type": "string"}
                },
                "required": ["order", "action", "tool", "params", "note"]
            },
            "minItems": 1
        }
    },
    "required": ["case_name", "case_desc", "steps"]
}


def check_order_continuity(steps: List[Dict[str, Any]]) -> bool:
    orders = [s.get("order") for s in steps]
    return orders == list(range(1, len(orders) + 1))

def fix_orders_inplace(steps: List[Dict[str, Any]]) -> None:
    for idx, step in enumerate(steps, start=1):
        step["order"] = idx
def extract_thinking_from_completion(resp) -> str | None:
    # 1) å…ˆå°è¯•ä» pydantic æ¨¡å‹ dumpï¼ˆéƒ¨åˆ†ç‰ˆæœ¬ä¼šä¿ç•™é¢å¤–å­—æ®µï¼‰
    raw = None
    for dumper in ("model_dump", "dict"):
        if hasattr(resp, dumper):
            try:
                raw = getattr(resp, dumper)(exclude_none=False)  # type: ignore
                break
            except Exception:
                pass

    # 2) å¦‚æœ dump å¤±è´¥ï¼Œå°è¯•æ‹¿â€œåŸå§‹å“åº”â€ï¼ˆéƒ¨åˆ† SDK æä¾› with_raw_responseï¼‰
    if raw is None and hasattr(resp, "_raw_response"):
        try:
            raw = resp._raw_response.json()  # éå…¬å¼€å±æ€§ï¼Œå­˜åœ¨å°±ç”¨
        except Exception:
            pass

    # 3) ç»Ÿä¸€ä»åŸå§‹å­—å…¸é‡Œæ‰¾å­—æ®µ
    if isinstance(raw, dict):
        ch0 = (raw.get("choices") or [{}])[0]
        msg = ch0.get("message") or {}
        return (
            msg.get("reasoning")               # OpenRouter ç­‰
            or msg.get("reasoning_content")    # DashScope æµå¼èšåˆå
            or ch0.get("reasoning")            # æœ‰äº›æä¾›æ–¹æ”¾åœ¨ choice å±‚
        )

    # 4) å…œåº•ï¼šæœ‰äº›æ¨¡å‹æŠŠ <think> ... </think> æ··åœ¨ content é‡Œ
    try:
        import re
        content = (resp.choices[0].message.content or "")
        m = re.search(r"<think>(.*?)</think>", content, flags=re.S)
        return m.group(1).strip() if m else None
    except Exception:
        return None
def run_plan_chat(case_name: str,
                  case_desc: str,
                  context_json: str=CONTEXT_JSON,
                  model: str = "qwen3-235b-a22b-thinking-2507",
                  max_retries: int = 3) -> tuple[dict[str, Any], str]:
    
    print(f"ğŸ¤– è°ƒç”¨LLMç”Ÿæˆæµ‹è¯•è®¡åˆ’...")
    print(f"   - æ¨¡å‹: {model}")
    print(f"   - ç«¯ç‚¹: {client.base_url}")

    user_context = "ã€ä¸Šä¸‹æ–‡JSONã€‘\n" + context_json
    task = json.dumps({"case_name": case_name, "case_desc": case_desc}, ensure_ascii=False)

    messages = [
        {"role": "system", "content": SYSTEM_PROMPT},
        {"role": "system", "content": "åœ¨ä¸ç‰ºç‰²çœŸå®æ€§çš„å‰æä¸‹ï¼Œä¼˜å…ˆè¾“å‡ºå¯è¿ç§»ã€å¯å‚æ•°åŒ–ã€å¯å¤ç°çš„æ­¥éª¤ã€‚"},
        {"role": "user", "content": user_context},
        {"role": "user", "content": task}
    ]

    last_err: Exception | None = None
    for attempt in range(1, max_retries + 1):
        try:
            resp = client.chat.completions.create(
                model=model,
                messages=messages,
                #response_format={"type": "json_object"},
                temperature=0,   # â˜…ç•¥å‡æ¸©ä»¥æå‡æ³›åŒ–
                #top_p=0.9          # â˜…é…åˆé‡‡æ ·ï¼Œä»å—ç³»ç»Ÿçº¦æŸ
            )
            txt = resp.choices[0].message.content  
            data = json.loads(txt)
            thinking_content = extract_thinking_from_completion(resp)
            #print(f"æ¨¡å‹è¾“å‡ºï¼š{json.dumps(data, ensure_ascii=False, indent=2)}")
            #print(f"æ¨¡å‹æ€è€ƒï¼š{thinking_content}")
            validate(instance=data, schema=PLAN_SCHEMA)

            if not check_order_continuity(data["steps"]):
                if AUTO_FIX_ORDER:
                    data["steps"].sort(
                        key=lambda s: (s.get("order")
                                       if isinstance(s.get("order"), int)
                                       else 10**9)
                    )
                    fix_orders_inplace(data["steps"])
                else:
                    raise ValidationError(
                        f"order ä¸è¿ç»­: {[s['order'] for s in data['steps']]}")
            return data,thinking_content

        except Exception as e:
            last_err = e
            print(f"âŒ ç¬¬ {attempt}/{max_retries} æ¬¡å¤±è´¥ï¼š{e}")
            time.sleep(1)

    raise RuntimeError(f"é‡è¯•åä»å¤±è´¥ï¼š{last_err}")
def edit_plan_chat(case_name: str,
                   case_desc: str,
                   user_request: str,
                   current_plan: Dict[str, Any],
                   context_json: str=CONTEXT_JSON,
                   model: str = "qwen3-235b-a22b-thinking-2507",
                   max_retries: int = 3) -> tuple[dict[str, Any], str]:
    EDIT_SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€åâ€œæµ‹è¯•è®¡åˆ’ä¿®æ”¹å™¨ï¼ˆTest Planner, Editorï¼‰â€ã€‚
ä½ çš„è¾“å…¥å°†åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼š
ã€ä¸Šä¸‹æ–‡JSONã€‘ï¼šå·¥å…·æ¸…å•ã€ç¤ºä¾‹ç”¨æ³•ã€é€šç”¨çº¦æŸï¼›
ã€å½“å‰è®¡åˆ’ã€‘ï¼šä¸€ä»½â€œå®Œæ•´çš„ç°æœ‰è®¡åˆ’ï¼ˆJSONï¼‰â€ï¼›
 user_requestä¸­çš„ ã€ä¿®æ”¹éœ€æ±‚ã€‘ï¼šç”¨æˆ·å¸Œæœ›å¯¹è®¡åˆ’åšå‡ºçš„å˜æ›´ï¼ˆå¯èƒ½æ˜¯å‚æ•°ä¿®æ”¹ã€æ–°å¢è‹¥å¹²æ­¥éª¤ã€åˆ é™¤è‹¥å¹²æ­¥éª¤ã€æˆ–ä¸‰è€…çš„ä»»æ„ç»„åˆï¼‰ã€‚
ä½ çš„ä»»åŠ¡ï¼šåœ¨ä¸¥æ ¼éµå¾ªâ€œä¸Šä¸‹æ–‡JSONâ€çš„äº‹å®ä¸å·¥å…·é›†åˆçš„å‰æä¸‹ï¼ŒåŸºäºå½“å‰è®¡åˆ’æ‰§è¡Œæœ€å°å¿…è¦ä¿®æ”¹ï¼Œè¾“å‡ºâ€œå®Œæ•´çš„æ–°è®¡åˆ’ï¼ˆJSONï¼‰â€ã€‚
ä¸¥ç¦å‡­ç©ºå‘æ˜ä¸Šä¸‹æ–‡ä¹‹å¤–çš„å·¥å…·æˆ–å‚æ•°é”®åï¼›ä¸¥ç¦æ— æ•…æ”¹å†™æœªæ¶‰åŠçš„æ­¥éª¤å†…å®¹ã€‚
**å¦‚æœã€ä¿®æ”¹éœ€æ±‚ã€‘user_requestä¸­æ²¡æœ‰ä»»ä½•ä¿®æ”¹éœ€æ±‚æˆ–è€…ç”¨æˆ·è¡¨ç¤ºå¯¹å½“å‰è®¡åˆ’çš„è‚¯å®šå’Œè¿›å…¥æ‰§è¡Œé˜¶æ®µçš„éœ€æ±‚(å¦‚"å¥½","å¯ä»¥","æ‰§è¡Œå§","æ²¡é—®é¢˜","å¼€å§‹æµ‹è¯•"),è¯·å°†å½“å‰è®¡åˆ’ä¸­çš„typeå­—æ®µç›´æ¥æ”¹ä¸º2å¹¶è¿”å›è®¡åˆ’.**
ã€ç¼–è¾‘æ€»åŸåˆ™ï½œMinimal-Diffã€‘

åªæ”¹éœ€è¦æ”¹çš„ï¼šæœªè¢«ä¿®æ”¹éœ€æ±‚æ³¢åŠçš„æ­¥éª¤ï¼Œå…¶ action/tool/params/note ä¿æŒé€å­—ä¸å˜ã€‚
å‚æ•°ä¿®æ”¹ä¼˜å…ˆï¼šä¿®æ”¹è¯·æ±‚ä»…æ¶‰åŠå‚æ•°æ—¶ï¼Œå°½é‡åªæ”¹åŠ¨å¯¹åº”æ­¥éª¤çš„ params ä¸ note çš„å¿…è¦éƒ¨åˆ†ï¼Œé¿å…æ”¹å†™ action/toolã€‚
æ–°å¢/åˆ é™¤ï¼š
æ–°å¢æ­¥éª¤æ—¶ï¼Œé€‰æ‹©æœ€åˆç†çš„æ’å…¥ä½ç½®ï¼ˆéµå¾ª Setup â†’ Run â†’ Monitor/Log â†’ Validate â†’ Collect/Upload â†’ Cleanup çš„éª¨æ¶ï¼‰ï¼Œå¹¶ä¿è¯ order è¿ç»­ã€‚å³æ³¨æ„æ›´æ”¹åç»­æ­¥éª¤çš„ orderã€‚

åˆ é™¤æ­¥éª¤æ—¶ï¼Œä»…åˆ é™¤è¢«æ˜ç¡®ç‚¹åæˆ–ç¡®å®å†—ä½™çš„æ­¥éª¤ï¼Œéšåé‡æ’ order ä»¥ä¿æŒä» 1 è¿ç»­ã€‚

é¡ºåºä¸ç¨³å®šæ€§ï¼šé™¤éç”¨æˆ·æ˜ç¡®è¦æ±‚æˆ–ä¸ºæ»¡è¶³éª¨æ¶/ä¾èµ–å…³ç³»ç¡®æœ‰å¿…è¦ï¼Œä¸è¦éšæ„é‡æ’ç°æœ‰æ­¥éª¤é¡ºåºã€‚

æ­¥æ•°å‚è€ƒï¼šå½“ã€ä¸Šä¸‹æ–‡JSONã€‘ä¸­å­˜åœ¨ä¸æœ¬ case é«˜ç›¸ä¼¼åº¦çš„æ¡ç›®ï¼Œå¯å‚è€ƒå…¶æ­¥éª¤æ•°é‡ä¸ç»“æ„ï¼›ä½†ä¸å¾—ç‰ºç‰² minimal-diff åŸåˆ™ã€‚



ã€è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼ JSONï¼ŒUTF-8ã€æ— æ³¨é‡Šã€æ— å¤šä½™æ–‡æœ¬ï¼‰ã€‘
{
  "case_name": string,
  "case_desc": string,
  "type": integer âˆˆ {1,2},
  "steps": [
    { "order": integer>=1, "action": string, "tool": string, "params": string, "note": string }
  ]
}

ã€å­—æ®µè¦æ±‚ã€‘
- steps.typeï¼š1 è¡¨ç¤ºè®¡åˆ’é˜¶æ®µï¼ˆå½“å‰ä¸è°ƒç”¨å·¥å…·ï¼Œä¾›äººåœ¨ç¯ç¡®è®¤/ä¿®æ”¹ï¼‰ï¼Œ2 è¡¨ç¤ºå·²è·ç¡®è®¤ã€å°†å®é™…è°ƒç”¨å·¥å…·ã€‚
é»˜è®¤å…¨éƒ¨å¡« 1ï¼ˆè§„åˆ’é˜¶æ®µä¸ç›´æ¥ä¸‹å‘æ‰§è¡Œï¼‰ã€‚
è‹¥ case_desc æ˜ç¡®è¦æ±‚â€œå¿…é¡»ç«‹å³æ‰§è¡Œâ€çš„é¢„æ£€/æ¸…ç†ï¼Œå¯æ ‡è®°ä¸º 2ï¼Œå¹¶åœ¨ note é‡Œè¯´æ˜ä¾æ®ã€‚
- steps.orderï¼šä» 1 å¼€å§‹è¿ç»­é€’å¢ï¼Œå¹¶ä¸æ­¥éª¤æ’åˆ—é¡ºåºä¸€è‡´ã€‚
- actionï¼šä¸€å¥è¯å‘½ä»¤å¼æè¿°ï¼Œé¿å…å«ç³Šï¼ˆå¦‚â€œå¯åŠ¨æµ‹è¯•å¹¶è®¾ç½®æ—¶é•¿ 240minâ€ï¼‰ã€‚
- toolï¼šå¿…é¡»æ˜¯**ä¸Šä¸‹æ–‡JSONé‡Œåˆ—å‡ºçš„åˆæ³•å·¥å…·å**ï¼ˆè‹¥è¯­ä¹‰æ˜ å°„ï¼Œè¯·ç”¨è¢«æ˜ å°„åçš„**ä¸Šä¸‹æ–‡å·¥å…·å**ï¼‰ã€‚
- paramsï¼šå¿…é¡»æ˜¯**å•ä¸€å­—ç¬¦ä¸²**ã€‚ä¸¥ç¦è¾“å‡ºæ•°ç»„æˆ–å¯¹è±¡ã€‚è‹¥éœ€è¦å¤šä¸ªå‚æ•°ï¼Œç”¨ç©ºæ ¼è¿æ¥ï¼›ç¤ºä¾‹ï¼š"--duration 240m --fullscreen true"ã€‚
è‹¥ç¼ºå‚è¯·ç½®ä¸º "" å¹¶åœ¨ note è¯´æ˜â€œå‚æ•°æœªåœ¨æ–‡æ¡£ä¸­ç»™å‡ºâ€ã€‚
- noteï¼šè¯·æ³¨æ„noteåº”å½“è¢«é€‚åº¦ä¿®æ”¹,å†™æ˜ä¸ä¸Šä¸‹æ–‡çš„**å¯¹åº”å…³ç³»/è¯æ®**ï¼ˆå¼•ç”¨ä½ ä¾æ®çš„ä¸Šä¸‹æ–‡æ¡ç›®æ ‡é¢˜æˆ–ç‰‡æ®µå…³é”®è¯ï¼‰ï¼Œä»¥åŠï¼š
  - å¦‚æœä½¿ç”¨çš„å·¥å…·ç”¨åˆ°çš„å‚æ•°ä¸åŒäºä¸Šä¸‹æ–‡æ¡ç›®ä¸­æåˆ°çš„å·¥å…·å‚æ•°çš„ä¿¡æ¯,è¯·æ³¨æ„é€‚åº¦ä¿®æ”¹noteå‚æ•°.ä¾‹å¦‚"Perf_3DMark_2cycles"æ”¹ä¸º"Perf_3DMark_5cycles"ä¹‹å,"note": "å¯¹åº”ä¸Šä¸‹æ–‡æ¡ç›®ï¼šæµ‹è¯•3DMark_SpeedWay_2cycles"åº”ä¿®æ”¹ä¸º      "note": "å¯¹åº”ä¸Šä¸‹æ–‡æ¡ç›®ï¼šæµ‹è¯•3DMark_SpeedWay_5cycles"è‹¥åšäº†åˆç†é»˜è®¤/æ¨æ–­ï¼ˆä¾‹å¦‚æŠŠâ€œæ—¶é•¿=240minâ€å¯¹é½ä¸ºå·¥å…·æ”¯æŒçš„ `--duration 240m`ï¼‰ï¼Œè¯·è¯´æ˜â€œæ¨æ–­ï¼šâ€¦ï¼ˆå¯è¢«è¦†ç›–ï¼‰â€
  - è‹¥åšäº†å·¥å…·åæ˜ å°„ï¼Œæ³¨æ˜â€œæ˜ å°„ï¼šA->Bï¼Œç†ç”±ï¼šâ€¦â€
  - è‹¥ç¼ºå°‘å‚æ•°ï¼Œæ³¨æ˜â€œå‚æ•°æœªåœ¨æ–‡æ¡£ä¸­ç»™å‡ºâ€

ã€æŠ½è±¡åŒ–ä¸æ³›åŒ–å‡†åˆ™ã€‘
1) **Setup â†’ Run â†’ Monitor/Log â†’ Validate â†’ Collect/Upload â†’ Cleanup** çš„é€šç”¨éª¨æ¶ä¼˜å…ˆï¼ˆç¼ºé¡¹å¯çœç•¥ï¼‰ã€‚
2) å°½é‡é¿å…ï¼š
   - ä»…é ç•Œé¢åƒç´ åæ ‡/æˆªå›¾åŒ¹é…çš„æ­¥éª¤ï¼›
   - æœºå‹/ç³»ç»Ÿç‰ˆæœ¬å¼ºç»‘å®šçš„æªè¾ï¼ˆè‹¥ä¸Šä¸‹æ–‡ç¡®æœ‰æ­¤é™åˆ¶ï¼Œéœ€åœ¨ note é‡Œæ ‡æ˜â€œå—é™æ¡ä»¶ï¼šâ€¦â€ï¼‰ã€‚
3) è‹¥ case è¦æ±‚çš„åŠŸèƒ½åœ¨ä¸Šä¸‹æ–‡ä¸­è¢«å¤šä¸ªå·¥å…·è¦†ç›–ï¼Œé€‰æ‹©**è¦†ç›–åº¦æœ€é«˜ä¸”å‚æ•°æ›´ç¨³å®š**çš„å·¥å…·ï¼Œå¹¶åœ¨ note ä¸­ç®€è¿°å–èˆã€‚
4) å¤±è´¥/é‡è¯•é€»è¾‘å¯å‡ç»ƒä¸ºâ€œç¨³å®šç”¨æ³•â€æè¿°ï¼ˆä¾‹å¦‚â€œè‹¥è¿”å›ç é 0ï¼Œåˆ™é‡è¯• â‰¤3 æ¬¡ã€é—´éš” 30sâ€ï¼‰ï¼Œä½†**ä¸å¾—å‘æ˜**ä¸Šä¸‹æ–‡ä¸­ä¸å­˜åœ¨çš„å…·ä½“æŒ‡ä»¤æˆ–å‚æ•°åã€‚

ã€å½“ä¿¡æ¯ç¼ºå¤±æ—¶ã€‘
- ç»ä¸ç¼–é€ å·¥å…·æˆ–è™šæ„å‚æ•°å­—æ®µåã€‚
- å…è®¸ç»™å‡º**å ä½**å‚æ•°ï¼ˆ""ï¼‰ï¼Œå¹¶åœ¨ note ä¸­å†™æ˜â€œå‚æ•°æœªåœ¨æ–‡æ¡£ä¸­ç»™å‡ºï¼Œéœ€ç”±æ‰§è¡Œç«¯è¡¥å…¨â€ã€‚
- è‹¥ case_desc ä¸­å‡ºç°ä¸Šä¸‹æ–‡æœªè¦†ç›–çš„å…·ä½“åè¯ï¼ˆä¾‹å¦‚æŸå­åœºæ™¯æˆ–æµ‹è¯•é¡¹åç§°ï¼‰ï¼Œ
  åªè¿›è¡Œ**è¯­ä¹‰å¯¹é½**åˆ°æœ€æ¥è¿‘çš„å·²çŸ¥åŠŸèƒ½ï¼Œä¸å¾—å‘æ˜æ–°åŠŸèƒ½ï¼›åœ¨ note è¯´æ˜â€œè¿‘ä¼¼å¯¹é½é¡¹ï¼šâ€¦â€ã€‚

ã€è´¨é‡æ£€æŸ¥æ¸…å•ï¼ˆè‡ªæ£€ï¼Œä½“ç°åˆ°æœ€ç»ˆè¾“å‡ºï¼Œä½†ä¸é¢å¤–è¾“å‡ºè§£é‡Šæ–‡æœ¬ï¼‰ã€‘
- [âœ“] tool å‡åœ¨ä¸Šä¸‹æ–‡å·¥å…·åˆ—è¡¨å†…ï¼ˆæˆ–å·²è¯´æ˜åˆ«åâ†’æ­£å¼åçš„æ˜ å°„ï¼‰ã€‚
- [âœ“] params ä»…ä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­å­˜åœ¨/ç¤ºä¾‹åŒ–çš„å‚æ•°é”®ï¼›å¦åˆ™ç½®ç©ºå¹¶åœ¨ note æ ‡æ³¨ç¼ºå‚ã€‚
- [âœ“] æ­¥éª¤é¡ºåºè¿ç»­ä¸”ä¸é‡å¤ï¼›åŠ¨ä½œè¯­ä¹‰åŸå­ã€å¯å¤ç°ã€‚
- [âœ“] æœ‰æœ€å°‘é‡ä½†å…³é”®çš„æ ¡éªŒ/æ—¥å¿—/ä¸Šä¼ æ­¥éª¤ï¼ˆè‹¥ä¸Šä¸‹æ–‡æåŠï¼‰ã€‚
- [âœ“] ä¸å‡ºç°ä¸å…·ä½“ UI åƒç´ ç»‘å®šçš„è¡¨è¿°ï¼ˆé™¤éä¸Šä¸‹æ–‡æ˜ç¡®è¦æ±‚å¹¶ç»™å‡ºæ–¹æ³•ï¼‰ã€‚

ä»…è¾“å‡ºç¬¦åˆä¸Šè¿°ç»“æ„ä¸è§„åˆ™çš„ JSONã€‚
""".strip()
        
    print(f"ğŸ¤– è°ƒç”¨LLMä¿®æ”¹æµ‹è¯•è®¡åˆ’...")
    print(f"   - æ¨¡å‹: {model}")
    print(f"   - ç«¯ç‚¹: {client.base_url}")

    user_context = "ã€ä¸Šä¸‹æ–‡JSONã€‘\n" + context_json
    #task = json.dumps({"cmd": case_name, "cmd_desc": case_desc}, ensure_ascii=False)

    messages = [
        {"role": "system", "content": EDIT_SYSTEM_PROMPT},
        {"role": "system", "content": "ã€å½“å‰è®¡åˆ’ä¸ºã€‘\n"+ json.dumps(current_plan, ensure_ascii=False, indent=2)},
        {"role": "user", "content": user_context},
        {"role": "user", "content": "ã€ä¿®æ”¹éœ€æ±‚ã€‘\n"+ user_request}
    ]

    last_err: Exception | None = None
    for attempt in range(1, max_retries + 1):
        try:
            resp = client.chat.completions.create(
                model=model,
                messages=messages,
                #response_format={"type": "json_object"},
                temperature=0,   # â˜…ç•¥å‡æ¸©ä»¥æå‡æ³›åŒ–
                #top_p=0.9          # â˜…é…åˆé‡‡æ ·ï¼Œä»å—ç³»ç»Ÿçº¦æŸ
            )
            txt = resp.choices[0].message.content  
            data = json.loads(txt)
            thinking_content = extract_thinking_from_completion(resp)
            #print(f"æ¨¡å‹è¾“å‡ºï¼š{json.dumps(data, ensure_ascii=False, indent=2)}")
            #print(f"æ¨¡å‹æ€è€ƒï¼š{thinking_content}")
            validate(instance=data, schema=PLAN_SCHEMA)

            if not check_order_continuity(data["steps"]):
                if AUTO_FIX_ORDER:
                    data["steps"].sort(
                        key=lambda s: (s.get("order")
                                       if isinstance(s.get("order"), int)
                                       else 10**9)
                    )
                    fix_orders_inplace(data["steps"])
                else:
                    raise ValidationError(
                        f"order ä¸è¿ç»­: {[s['order'] for s in data['steps']]}")
            return data,thinking_content

        except Exception as e:
            last_err = e
            print(f"âŒ ç¬¬ {attempt}/{max_retries} æ¬¡å¤±è´¥ï¼š{e}")
            time.sleep(1)

    raise RuntimeError(f"é‡è¯•åä»å¤±è´¥ï¼š{last_err}")
def save_plan_to_json(plan: Dict[str, Any], path: pathlib.Path) -> None:
    path.write_text(json.dumps(plan, ensure_ascii=False, indent=2), encoding="utf-8")

if __name__ == "__main__":
    #context_json_str = load_context_json(CTX_PATH)
    case_name = ""
    case_desc = """å…ˆæŠŠæœºå™¨é‡å¯ï¼Œç„¶åè·‘Burninæµ‹è¯•30åˆ†é’Ÿï¼Œåš1æ¬¡S4ï¼Œå†è·‘burnin 30åˆ†é’Ÿ"""
    plan,thinking = run_plan_chat(
        case_name=case_name,
        case_desc=case_desc,
        context_json=CONTEXT_JSON,
        model="qwen3-235b-a22b-thinking-2507",
        max_retries=3
    )
    print(json.dumps(plan, ensure_ascii=False, indent=2))
    print("thinking",thinking)
